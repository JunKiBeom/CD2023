<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>매물차트</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .container {
            display: flex;
        }
        .chart-container {
            flex: 1;
            margin-right: 20px;
        }
        canvas {
            width: 100%;
            height: auto;
        }
        .property-list {
            flex: 1;
            width: 200px;
            padding: 10px;
            background-color: #f2f2f2;
            font-size: 14px;
        }
        .property-item {
            margin-bottom: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<h1> 검색을 시도한 주소 : {{ addr }}</h1>
<p style='display: none'> 실거래가 평균 : {{ act_average_ppa }}, 호가 평균 : {{ get_average_ppa }}</p>
<div id="addressForm" style="margin: 50px">
    <form action="showlist" method="POST"> {%csrf_token%}
        <label for="city">시/도:</label>
        <select id="city" name="city">
            <option value="">시/도 선택</option>
            <option value="서울시">서울특별시</option>
            <option value="대전시">대전광역시</option>
            <option value="부산시">부산광역시</option>
            <option value="인천시">인천광역시</option>
            <option value="광주시">광주광역시</option>
            <option value="대구시">대구광역시</option>
            <option value="울산시">울산광역시</option>
            <option value="세종시">세종특별자치시</option>
            <option value="경기도">경기도</option>
            <option value="강원도">강원도</option>
            <option value="충청북도">충청북도</option>
            <option value="충청남도">충청남도</option>
            <option value="전라북도">전라북도</option>
            <option value="전라남도">전라남도</option>
            <option value="경상북도">경상북도</option>
            <option value="경상남도">경상남도</option>
            <option value="제주도">제주특별자치도</option>
            <!-- 다른 시들을 추가해 주세요 -->
        </select>

        <label for="district">시/구/군:</label>
        <select id="district" name="district">
            <option value="">시/구/군 선택</option>
        </select>

        <label for="address">시/구/군:</label>
        <select id="address" name="address">
            <option value="">읍/면/동 선택</option>
        </select>

        <script src="../static/js/searchRegion.js"></script>

        <!--        <label for="address">상세 주소:</label>-->
        <!--        <input type="text" id="address" name="address">-->

        <!--        <input type="submit" value="검색" id="searchBtn" name="searchBtn" onclick="searchBtn()" class="btn_submit">-->
        <button id="searchBtn" onclick="searchBtn()">검색</button>


    </form>
</div>

<div class="container">
    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>
    <div class="property-list" style="overflow-y: scroll; height:400px;">
        <h2>매물 목록</h2>
        {% if product_list %}
        <ul id="propertyItems">
            {% for product in product_list %}
            {% if product.address == addr %}
            <li class="property-item">
                <input type="checkbox" name="property" class="property-check" value="{{ forloop.index0 }}">
                <span style="display: inline-block; width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ product.content }}</span>
                <span id="ppa{{ forloop.index0 }}" style="display: none;">{{ product.ppa }}</span>
                <input type='button' value='>>!' id='btn_toggle{{ forloop.index0 }}' onclick='toggleBtn()'/>
                <div id="data{{ forloop.index0 }}" style="display: inline-block">
                    데이터 출처 : {{ product.flag }} <br>
                    관리번호 : {{ product.item_id }} <br>
                    주거타입 : {{ product.service_type }} <br>
                    거래타입 : {{ product.sales_type }} <br>
                    층 : {{ product.floor }} <br>
                    월세 : {{ product.rent_price }} 만원<br>
                    보증금 : {{ product.deposit }} 만원 <br>
                    공급면적 / 전용면적: {{ product.supply_area }} ㎡ / {{ product.use_area }} ㎡<br>
                    특이사항 : {{ product.content }} <br>
                    URL : <a href="{{ product.url }}">{{ product.url }}</a> <br>
                    등록날짜 : {{ product.date }} <br>
                    면적당 가격 : {{ product.ppa }} 만원<br>
                </div>
            </li>
            {% endif %}
            {% endfor %}
        </ul>
        {% else %}
        <p>목록이 없습니다.</p>
        {% endif %}
    </div>
</div>



<script>
    function toggleBtn() {
        var dataDiv = document.getElementById("data{{ forloop.index0 }}");
        if (dataDiv.style.display === "none") {
            dataDiv.style.display = "inline-block";
            // btn_toggle.value = "<<!";
        } else {
            dataDiv.style.display = "none";
            // btn_toggle.value = ">>!";
        }
    }
</script>

<script>
    // 차트 데이터
    var get_average_ppa = '{{ get_average_ppa|escapejs }}';
    var act_average_ppa = '{{ act_average_ppa|escapejs }}';
    var data = {
        labels: ["실거래가 평균 (구 단위 평균)", "호가 평균 (동 단위 평균)"],
        datasets: [{
            label: "단위 (만 원)",
            data: [act_average_ppa, get_average_ppa],
            borderColor: "rgba(75, 192, 192, 1)",
            backgroundColor: "rgba(75, 192, 192, 0.2)",
            fill: true
        }]
    };

    // 차트 옵션
    var options = {
        responsive: true,
        title: {
            display: true,
            text: "Monthly Sales"
        },
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: true
                }
            }]
        }
    };

    // 차트 생성
    var ctx = document.getElementById("myChart").getContext("2d");
    var myChart = new Chart(ctx, {
        type: "bar",
        data: data,
        options: options
    });

    // 체크박스 변경 이벤트 처리
    var propertyItems = document.getElementsByClassName("property-item");
    var checkedCount = 0;

    // 매물 체크박스에 이벤트 리스너 등록
    var propertyCheckboxes = document.getElementsByClassName("property-check");
    for (var i = 0; i < propertyCheckboxes.length; i++) {
        propertyCheckboxes[i].addEventListener("change", function () {
            // 클릭된 매물의 인덱스를 가져옴
            var propertyIndex = Array.prototype.indexOf.call(propertyCheckboxes, this);
            // 선택한 매물의 ppa 값을 가져옴
            // var item_ppa = propertyItems[propertyIndex].querySelector("#ppa" + propertyIndex).innerText;
            var item_ppa = propertyItems[propertyIndex].querySelector("#ppa").innerText
            // var item_id = propertyItems[propertyIndex].querySelector("#item_id").innerText;

            if (this.checked) {
                checkedCount++;
                // 데이터 업데이트
                myChart.data.labels.push("선택 매물" + (propertyIndex+1));
                // myChart.data.labels.push(item_id);
                myChart.data.datasets[0].data.push(parseFloat(item_ppa));
            } else {
                checkedCount--;
                // 체크가 해제된 아이템 삭제
                myChart.data.labels = myChart.data.labels.filter((element) => element !== "선택 매물" + (propertyIndex+1))
                myChart.data.datasets[0].data = myChart.data.datasets[0].data.filter((element) => element !== parseFloat(item_ppa))
            }

            // 차트 업데이트
            myChart.update();
        });
    }

    // // 매물 목록 클릭 이벤트 처리
    // var propertyItems = document.getElementsByClassName("property-item");
    // for (var i = 0; i < propertyItems.length; i++) {
    //     propertyItems[i].addEventListener("click", function() {
    //         // 클릭된 매물의 인덱스를 가져옴
    //         var propertyIndex = Array.prototype.indexOf.call(propertyItems, this);
    //         // 선택한 매물의 ppa 값을 가져옴
    //         var item_ppa = propertyItems[propertyIndex].querySelector("#ppa").innerText;
    //         console.log(item_ppa, typeof parseFloat(item_ppa));
    //         // 데이터 업데이트
    //         myChart.data.datasets[0].data[2] = parseFloat(item_ppa);
    //         myChart.data.datasets[0].data[3] = 400;
    //         // 차트 업데이트
    //         myChart.update();
    //     });
    // }
</script>
</body>
</html>
